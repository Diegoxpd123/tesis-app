<div class="forgot-password-container starry-background" [class.dark-theme]="isDarkMode">
  <div class="forgot-password-card">
    <!-- Header -->
    <div class="forgot-password-header">
      <button type="button" class="back-button" (click)="goToLogin()">
        <i class="fas fa-arrow-left"></i>
        <span>Volver al Login</span>
      </button>

      <div class="logo-section">
        <i class="fas fa-key"></i>
        <h1>Recuperar Contraseña</h1>
        <p>Te ayudaremos a recuperar el acceso a tu cuenta</p>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>
      <div class="progress-text">
        Paso {{ currentStep }} de {{ totalSteps }}: {{ getStepTitle() }}
      </div>
    </div>

    <!-- Step Content -->
    <div class="step-content">

      <!-- Paso 1: Verificar Usuario -->
      <div class="step" *ngIf="currentStep === 1">
        <div class="step-header">
          <h2>{{ getStepTitle() }}</h2>
          <p>{{ getStepDescription() }}</p>
        </div>

        <form [formGroup]="step1Form" (ngSubmit)="onStep1Submit()">
          <div class="form-group">
            <label for="usuario">Usuario *</label>
            <input
              type="text"
              id="usuario"
              formControlName="usuario"
              class="form-input"
              [class.error]="isFieldInvalid(step1Form, 'usuario')"
              placeholder="Ingresa tu nombre de usuario"
              autocomplete="username"
              spellcheck="false">
            <div class="error-message" *ngIf="isFieldInvalid(step1Form, 'usuario')">
              {{ getErrorMessage(step1Form, 'usuario') }}
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="step1Form.invalid || loading">
              <i class="fas fa-arrow-right" *ngIf="!loading"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
              {{ loading ? 'Verificando...' : 'Siguiente' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Paso 2: Verificar DNI -->
      <div class="step" *ngIf="currentStep === 2">
        <div class="step-header">
          <h2>{{ getStepTitle() }}</h2>
          <p>{{ getStepDescription() }}</p>
          <div class="user-info" *ngIf="userData">
            <i class="fas fa-user"></i>
            <span>Usuario: {{ userData.usuario }}</span>
          </div>
        </div>

        <form [formGroup]="step2Form" (ngSubmit)="onStep2Submit()">
          <div class="form-group">
            <label for="dni">Últimos 4 dígitos del DNI *</label>
            <input
              type="text"
              id="dni"
              formControlName="dni"
              class="form-input"
              [class.error]="isFieldInvalid(step2Form, 'dni')"
              placeholder="Ingresa los últimos 4 dígitos"
              maxlength="4">
            <div class="error-message" *ngIf="isFieldInvalid(step2Form, 'dni')">
              {{ getErrorMessage(step2Form, 'dni') }}
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="goBack()">
              <i class="fas fa-arrow-left"></i>
              Anterior
            </button>
            <button type="submit" class="btn-primary" [disabled]="step2Form.invalid || loading">
              <i class="fas fa-arrow-right" *ngIf="!loading"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
              {{ loading ? 'Verificando...' : 'Siguiente' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Paso 3: Nueva Contraseña -->
      <div class="step" *ngIf="currentStep === 3">
        <div class="step-header">
          <h2>{{ getStepTitle() }}</h2>
          <p>{{ getStepDescription() }}</p>
          <div class="user-info" *ngIf="userData">
            <i class="fas fa-user"></i>
            <span>Usuario: {{ userData.usuario }}</span>
          </div>
        </div>

        <form [formGroup]="step3Form" (ngSubmit)="onStep3Submit()">
          <div class="form-group">
            <label for="password">Nueva Contraseña *</label>
            <input
              type="password"
              id="password"
              formControlName="password"
              class="form-input"
              [class.error]="isFieldInvalid(step3Form, 'password')"
              placeholder="Ingresa tu nueva contraseña">
            <div class="error-message" *ngIf="isFieldInvalid(step3Form, 'password')">
              {{ getErrorMessage(step3Form, 'password') }}
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirmar Nueva Contraseña *</label>
            <input
              type="password"
              id="confirmPassword"
              formControlName="confirmPassword"
              class="form-input"
              [class.error]="isFieldInvalid(step3Form, 'confirmPassword')"
              placeholder="Confirma tu nueva contraseña">
            <div class="error-message" *ngIf="isFieldInvalid(step3Form, 'confirmPassword')">
              {{ getErrorMessage(step3Form, 'confirmPassword') }}
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="goBack()">
              <i class="fas fa-arrow-left"></i>
              Anterior
            </button>
            <button type="submit" class="btn-primary" [disabled]="step3Form.invalid || loading">
              <i class="fas fa-save" *ngIf="!loading"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
              {{ loading ? 'Guardando...' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Mensajes de estado -->
    <div class="form-messages" *ngIf="errorMessage || successMessage">
      <div class="error-message" *ngIf="errorMessage">
        <i class="fas fa-exclamation-circle"></i>
        {{ errorMessage }}
      </div>
      <div class="success-message" *ngIf="successMessage">
        <i class="fas fa-check-circle"></i>
        {{ successMessage }}
        <div class="success-actions">
          <button class="btn-primary" (click)="goToLogin()">
            <i class="fas fa-home"></i>
            Ir a la página principal
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
